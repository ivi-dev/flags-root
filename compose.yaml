name: flags

services:
  db:
    build:
      context: Data-Harvester/DB
      dockerfile: Data-Harvester/DB/Dockerfile
    volumes:
      - db-config:/data/configdb
      - db-data:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME_FILE=/run/secrets/db-root-user
      - MONGO_INITDB_ROOT_PASSWORD_FILE=/run/secrets/db-root-pass
    ports:
      - "27017:27017"
    networks:
      - flags
  be:
    build:
      context: BE
      dockerfile: BE/Dockerfile
    volumes:
      - cert-public:/etc/ssl/certs/flags
      - cert-private:/etc/ssl/private/flags
    depends_on:
      - db
    networks:
      - flags
    ports:
      - "444:444"
  data-harvester:
    build:
      context: Data-Harvester
      dockerfile: Data-Harvester/Dockerfile
    depends_on:
      - db
    networks:
      - flags
  cert-manager:
    build:
      context: Certificate-Manager
      dockerfile: Certificate-Manager/Dockerfile
    volumes:
      - cert-public:/etc/ssl/certs/flags
      - cert-private:/etc/ssl/private/flags
  fe:
    build:
      context: FE
      dockerfile: FE/Dockerfile
    volumes:
      - cert-public:/etc/ssl/certs/flags
      - cert-private:/etc/ssl/private/flags
    depends_on:
      - be
    ports:
      - "443:444"
      - "80:80"

volumes:
  db-config:
  db-data:
  cert-public:
  cert-private:

secrets:
  db-root-user:
    file: ./.secrets/db-root-user
  db-root-pass:
    file: ./.secrets/db-root-pass

networks:
  flags: